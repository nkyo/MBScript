#!/bin/bash
# info: add mail domain
# options: USER DOMAIN [ANTISPAM] [ANTIVIRUS] [DKIM] [DKIM_SIZE]
# labels: mail
#
# example: v-add-mail-domain admin mydomain.tld
#
# The function adds MAIL domain.


#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Argument definition
user=$1
domain=$2
antispam=${3-yes}
antivirus=${4-yes}
dkim=${5-yes}
dkim_size=${6-1024}

# Includes
source $HESTIA/func/main.sh
source $HESTIA/func/domain.sh
source $HESTIA/conf/hestia.conf
source $HESTIA/func/ip.sh

# Define mail user
if [ "$MAIL_SYSTEM" = 'exim4' ]; then
    MAIL_USER=Debian-exim
else
    MAIL_USER=exim
fi

# Additional argument formatting
format_domain
format_domain_idn


#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '2' "$#" 'USER DOMAIN [ANTISPAM] [ANTIVIRUS] [DKIM] [DKIM_SIZE]'
is_format_valid 'user' 'domain' 'antispam' 'antivirus' 'dkim' 'dkim_size'
is_system_enabled "$MAIL_SYSTEM" 'MAIL_SYSTEM'
is_object_valid 'user' 'USER' "$user"
is_object_unsuspended 'user' 'USER' "$user"
is_domain_new 'mail' "$domain"
is_package_full 'MAIL_DOMAINS'
is_dir_symlink $HOMEDIR/$user/mail

# Perform verification if read-only mode is enabled
check_hestia_demo_mode


#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Inherit web domain local ip address
domain_ip=$(get_object_value 'web' 'DOMAIN' "$domain" '$IP')
if [ ! -z "$domain_ip" ]; then
    local_ip=$(get_real_ip "$domain_ip")
    is_ip_valid "$local_ip" "$user"
else
    get_user_ip
fi

# Generating timestamp
new_timestamp

# Adding domain to mail.conf
s="DOMAIN='$domain' ANTIVIRUS='$antivirus' ANTISPAM='$antispam' DKIM='$dkim'"
s="$s SSL='no' LETSENCRYPT='no' CATCHALL='' ACCOUNTS='0' U_DISK='0' SUSPENDED='no' TIME='$time'"
s="$s DATE='$date'"
echo $s >> $USER_DATA/mail.conf
touch $USER_DATA/mail/$domain.conf

# Generating DKIM keys
if [ "$dkim" = 'yes' ]; then
    openssl genrsa -out $USER_DATA/mail/$domain.pem $dkim_size &>/dev/null
    openssl rsa -pubout -in $USER_DATA/mail/$domain.pem \
        -out $USER_DATA/mail/$domain.pub &>/dev/null
fi

# Set permissions
chmod 660 $USER_DATA/mail/$domain.*
chmod 660 $USER_DATA/mail.conf

# Building exim configs
if [[ "$MAIL_SYSTEM" =~ exim ]]; then
    mkdir $HOMEDIR/$user/conf/mail/$domain
    mkdir $HOMEDIR/$user/mail/$domain_idn
    touch $HOMEDIR/$user/conf/mail/$domain/aliases
    touch $HOMEDIR/$user/conf/mail/$domain/passwd
    touch $HOMEDIR/$user/conf/mail/$domain/fwd_only
    ln -s $HOMEDIR/$user/conf/mail/$domain \
        /etc/$MAIL_SYSTEM/domains/$domain_idn

    # Seeting outgoing ip address
    if [ ! -z "$local_ip" ]; then
        echo "$local_ip" > $HOMEDIR/$user/conf/mail/$domain/ip
    fi

    # Touch mailhelo.conf if it doesnt exist
    if [ ! -f "/etc/exim4/mailhelo.conf" ]; then
        touch /etc/exim4/mailhelo.conf
    fi

    # Setting HELO for mail domain
    if [ ! -z "$local_ip" ]; then
        IP_RDNS=$(is_ip_rdns_valid "$local_ip")
        if [ ! -z "$IP_RDNS" ]; then
            if [ $(grep -s "^${domain}:" /etc/exim4/mailhelo.conf) ]; then
                sed -i "/^${domain}:/c\\${domain}:${IP_RDNS}" /etc/exim4/mailhelo.conf
            else
                echo ${domain}:${IP_RDNS} >> /etc/exim4/mailhelo.conf
            fi
        fi        
    fi

    # Adding antispam protection
    if [ "$antispam" = 'yes' ]; then
        touch $HOMEDIR/$user/conf/mail/$domain/antispam
    fi

    # Adding antivirus protection
    if [ "$antivirus" = 'yes' ]; then
        touch $HOMEDIR/$user/conf/mail/$domain/antivirus
    fi

    # Adding dkim support
    if [ "$dkim" = 'yes' ]; then
        cp -f $USER_DATA/mail/$domain.pem \
            $HOMEDIR/$user/conf/mail/$domain/dkim.pem
    fi

    # Set permission
    chmod 771 $HOMEDIR/$user/conf/mail/$domain
    chmod 660 $HOMEDIR/$user/conf/mail/$domain/*
    chmod 771 /etc/$MAIL_SYSTEM/domains/$domain_idn
    chmod 770 $HOMEDIR/$user/mail/$domain_idn

    # Set ownership
    chown -R $MAIL_USER:mail $HOMEDIR/$user/conf/mail/$domain
    if [ "$IMAP_SYSTEM" = 'dovecot' ]; then
        chown -R dovecot:mail $HOMEDIR/$user/conf/mail/$domain/passwd
    fi
    chown $user:mail $HOMEDIR/$user/mail/$domain_idn
fi

# Adding dkim dns records
if [ ! -z "$DNS_SYSTEM" ] && [ "$dkim" = 'yes' ]; then
    check_dns_domain=$(is_object_valid 'dns' 'DOMAIN' "$domain")
    if [ "$?" -eq 0 ]; then
        p=$(cat $USER_DATA/mail/$domain.pub|grep -v ' KEY---'|tr -d '\n')
        record='_domainkey'
        policy="\"t=y; o=~;\""
        $BIN/v-add-dns-record $user $domain $record TXT "$policy" '' '' 'no'

        record='mail._domainkey'
        selector="\"v=DKIM1\; k=rsa\; p=$p\""
        $BIN/v-add-dns-record $user $domain $record TXT "$selector"
    fi
fi

# Add webmail configuration to mail domain
if [ ! -z "$WEB_SYSTEM" ] || [ ! -z "$PROXY_SYSTEM" ]; then
    if [ ! -z "$IMAP_SYSTEM" ]; then
        $BIN/v-add-sys-webmail $user $domain ''
    fi
fi
    
#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

# Increasing domain value
increase_user_value "$user" '$U_MAIL_DOMAINS'

if [ "$dkim" = 'yes' ]; then
    increase_user_value "$user" '$U_MAIL_DKIM'
fi

# Restarting web server
$BIN/v-restart-web $restart
check_result $? "Web restart failed" >/dev/null

# Restarting proxy server
$BIN/v-restart-proxy $restart
check_result $? "Proxy restart failed" >/dev/null

# Logging
log_history "added mail domain $domain"
log_event "$OK" "$ARGUMENTS"

exit
